# Docker Registry Management
init:
	@echo "üê≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Docker Registry..."
	@mkdir -p data auth
	@if [ ! -f auth/htpasswd ]; then \
		echo ""; \
		echo "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'admin' –¥–ª—è Registry..."; \
		echo "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è admin:"; \
		htpasswd -Bc auth/htpasswd admin; \
		echo ""; \
		echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'admin' —Å–æ–∑–¥–∞–Ω"; \
	else \
		echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'admin' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"; \
	fi
	@docker compose up -d

up:
	@docker compose up -d

down:
	@docker compose down

restart:
	@docker compose restart

logs:
	@docker compose logs -f

ps:
	@docker compose ps

# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
add-user:
	@echo "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
	@read username && \
	echo "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $$username:" && \
	htpasswd -B auth/htpasswd $$username && \
	echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $$username –¥–æ–±–∞–≤–ª–µ–Ω"
	@docker-compose restart

# –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
change-password:
	@echo "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
	@read username && \
	echo "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $$username:" && \
	htpasswd -Bc auth/htpasswd $$username && \
	echo "‚úÖ –ü–∞—Ä–æ–ª—å –¥–ª—è $$username –∏–∑–º–µ–Ω–µ–Ω"
	@docker-compose restart

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
list-users:
	@echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Registry:"
	@cat auth/htpasswd | cut -d: -f1

# –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
remove-user:
	@echo "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:"
	@read username && \
	htpasswd -D auth/htpasswd $$username && \
	echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $$username —É–¥–∞–ª–µ–Ω"
	@docker-compose restart

# –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—Ä–∞–∑–æ–≤ –≤ Registry
list-images:
	@echo "–û–±—Ä–∞–∑—ã –≤ Registry:"
	@curl -s http://localhost:5000/v2/_catalog | jq -r '.repositories[]' 2>/dev/null || \
	curl -s http://localhost:5000/v2/_catalog

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–≥–æ–≤ –æ–±—Ä–∞–∑–∞
list-tags:
	@echo "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –æ–±—Ä–∞–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: vs-cms-php-fpm):"
	@read image && \
	curl -s http://localhost:5000/v2/$$image/tags/list | jq '.' 2>/dev/null || \
	curl -s http://localhost:5000/v2/$$image/tags/list

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
storage-size:
	@echo "–†–∞–∑–º–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ Registry:"
	@du -sh data 2>/dev/null || echo "–ü–∞–ø–∫–∞ data –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

# –°–ø—Ä–∞–≤–∫–∞
help:
	@echo "Docker Registry - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo ""
	@echo "–û—Å–Ω–æ–≤–Ω—ã–µ:"
	@echo "  make init              - –ü–µ—Ä–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è admin)"
	@echo "  make up                - –ó–∞–ø—É—Å—Ç–∏—Ç—å Registry"
	@echo "  make down              - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Registry"
	@echo "  make restart           - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Registry"
	@echo "  make logs              - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
	@echo "  make ps                - –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
	@echo ""
	@echo "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:"
	@echo "  make add-user          - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
	@echo "  make change-password   - –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
	@echo "  make list-users        - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
	@echo "  make remove-user       - –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
	@echo ""
	@echo "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞–º–∏:"
	@echo "  make list-images       - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞–∑–æ–≤"
	@echo "  make list-tags         - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–≥–∏ –æ–±—Ä–∞–∑–∞"
	@echo "  make storage-size      - –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–º–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞"

.PHONY: init up down restart logs ps add-user change-password list-users remove-user list-images list-tags cleanup storage-size clean help
